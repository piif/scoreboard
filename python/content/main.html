<html>
<head>
	<title>ScoreBoard Main Page</title>
	<style>
	.waiting {
		color: orange;
	}
	.onscreen {
		color: green;
	}
	.digitsblock, #chrono {
		display: inline-block;
		margin-bottom: 1ex;
		padding: 5px;
	}
	#chrono, #scores  {
		margin-left: 1em;
	}
	.digitsblock input, #chrono input {
		text-align: center;
	}
	#tools {
		border: dotted 1px gray;
		position: absolute;
		right: 0.5em;
		top: 0.5ex
	}
	#scores > div {
		display: inline-block;
		border: solid 1px;
	}
	label {
		display: block;
		text-align: center;
	}
	input {
		width: 3em;
	}
	/* icons */
	img {
		width: 3ex;
		padding: 0.5ex;
		vertical-align: middle;
	}
	</style>
</head>

<body>
	<script src='/static/jquery-3.1.0.js'></script>
	<script>
	var currentPoll = null;

	var chronoList = null;

	function iconpath(action) {
		return '/static/img/' + action + '.png';
	}

	function setError(msg) {
		$("#message").html(msg);
	}
	function poll() {
		var poll_interval=0;
	
		currentPoll = $.ajax({
			url: "/poll",
			type: 'GET',
			dataType: 'json',
			success: function(data) {
				handleMessage(data);
				poll_interval=0;
			},
			error: function (xhr, status, error) {
				poll_interval=1000;
				setError("Poll error : " + status + "/" + error);
			},
			complete: function () {
				setTimeout(poll, poll_interval);
			},
		});
	}
	function handleMessage(data) {
		console.log(data);
		for (k in data) {
			if (k == 'error') {
				setError(data[k])
			} else {
				$('#'+k)
					.val(data[k])
					.removeClass('waiting').addClass('onscreen');
			}
		}
		if (data.Minutes === 0 && data.Seconds === 0) {
			playpause("pause");
		}
		//$('#message').html("<pre>message " + JSON.stringify(data) + "</pre>");
	}

	playpause = function(state) {
		if (state === "pause") {
			// send pause
			send('/pause', "Can't stop chrono");
			// set icon to 'unpause'
			$("#playpause")
				.removeClass('pause').addClass('play')
				.attr('src', iconpath('play'))
				.attr('title', 'play')
		} else if (state === "play") {
			// send unpause
			send('/play', "Can't restart chrono");
			// set icon to 'pause'
			$("#playpause")
				.addClass('pause').removeClass('play')
				.attr('src', iconpath('pause'))
				.attr('title', 'pause')
		}
	}

	function scoreButton(prefix, name, len) {
		var html = $('<div>')
			.addClass('digitsblock')
			.attr('id', name+'_block');
		html.append(
			prefix
			,
			$('<img>')
				.addClass('minus')
				.attr('src', iconpath('minus'))
				.attr('id', name+'_minus')
				.attr('rel', name)
				.attr('title', '-')
			,
			$('<input>')
				.addClass('digits')
				.attr('type', 'text')
				.attr('id', name)
				.attr('size', len)
				.val('_'.repeat(len))
			,
			$('<img>')
				.addClass('plus')
				.attr('src', iconpath('plus'))
				.attr('id', name+'_plus')
				.attr('rel', name)
				.attr('title', '+')
		);

		return html;
		//$('#scores').append(html);
	}

	function addToolsButton(action, onclick) {
		if (onclick == null) {
			onclick = function(){
				$('.digits').addClass('waiting').removeClass('onscreen');
				send('/' + action, "Can't " + action);
			};
		}
		$('#tools').append(
			$('<img>')
				.attr('src', iconpath(action))
				.attr('id', action)
				.attr('title', action)
				.addClass(action)
				.click(onclick)
		);
	}

	function updateTimeList() {
		var value = $("#timelist").val();
		if (value == "manuel") {
			$("#startbuttons").html("");
		} else {
			var newList = chronoList[value];
			console.log(newList);
			$("#startbuttons").html('')
			for (period in newList) {
				$("#startbuttons").append( $('<input>')
					.attr('type', 'button')
					.attr('id', 'start_' + period)
					.attr('rel', newList[period])
					.val(period)
					.addClass('start')
					.click(function() {
						var time = $(this).attr('rel');
						send('/start/' + time, "Can't start chrono");
						playpause("play");
					})
				);
			}
		}
	}

	function addChrono() {
		$('#chrono').append(
			// time list
			$('<select>')
				.attr('id', 'timelist')
				.change(updateTimeList)
			,
			// start buttons
			$('<span>')
				.attr('id', 'startbuttons')
			,
			// digits
			$('<input>')
				.attr('type', 'number')
				.attr('id', 'Minutes')
				.attr('min', '0').attr('max', '59')
				.attr('size', '2')
				.val('__')
				.addClass('digits')
			,
			$('<span> : </span>')
			,
			$('<input>')
				.attr('type', 'number')
				.attr('id', 'Seconds')
				.attr('min', '0').attr('max', '59')
				.attr('size', '2')
				.val('__')
				.addClass('digits')
			,
			// pause / play
			$('<img>')
				.attr('id', 'playpause')
				.attr('src', iconpath('play'))
				.attr('title', 'play')
				.addClass('play')
				.click(function() {
					playpause($(this).hasClass('pause') ? "pause" : "play");
				})
		);
	}

	$( document ).ready(function() {
		// add scores button
		$('#scores').append(
			$("<div><label>Locaux</label></div>").append(
				scoreButton('<label>fautes</label>', 'FL', 1),
				scoreButton('<label>buts</label>', 'BL', 2)
			),
			$("<div><label>Visiteurs</label></div>").append(
				scoreButton('<label>fautes</label>', 'FV', 1),
				scoreButton('<label>buts</label>', 'BV', 2)
			)
		);

		addChrono();
		$.ajax({
			url: "/chronos",
			type: 'GET',
			dataType: 'json',
			success: function(data) {
				chronoList = data;
				list = $("#timelist");
				list.append( $("<option>").val("manuel").text("manuel") );
				for (lbl in data) {
					list.append( $("<option>").val(lbl).text(lbl) );
				}
			},
			error: function (xhr, status, error) {
				setError("Can't load time list : " + status + "/" + error);
			}
		});

		// handle +/-
		$('.plus').click(function() {
			var rel = $(this).attr('rel');
			var target = $('#'+rel)
			changeValue(rel, target, 1);
		});
		$('.minus').click(function() {
			var rel = $(this).attr('rel');
			var target = $('#'+rel)
			changeValue(rel, target, -1);
		});
		// and direct input
		$('.digits')
			.focus(function() {
				$(this).removeClass('waiting').removeClass('onscreen');
			})
			.change(function() {
				var target = $(this);
				var rel = target.attr('id')
				changeValue(rel, target);
			});

		addToolsButton('refresh');
		addToolsButton('test');
		addToolsButton('blank');
		addToolsButton('reset', function() {
			if (confirm("Tout r√©-initialiser ?")) {
				send('/reset', "Can't reset");
			}
		});
		addToolsButton('reload', function(){
			window.location.reload();
		});

		poll('/poll');
	});

	function changeValue(rel, target, delta) {
		var value = Number.parseInt(target.val());
		if (delta != null) {
			value += delta;
		}

		send('/' + rel + '/' + value, "Can't set " + rel + " to " + value);
		target.addClass('waiting').removeClass('onscreen');
	}

	function send(action, errorMessage) {
		$.ajax({
			url: action,
			type: 'GET',
			error: function(xhr, status, error) {
				setError(errorMessage + " : " + status + "/" + error);
			}
		});
	}
	</script>
	<div id='message'></div>
	<div id='tools'></div>

	<h1>Score board</h1>
	<div id='chrono'></div>
	<div id='scores'></div>
</body>
</html>
