<html>
<head>
	<title>ScoreBoard Main Page</title>
	<style>
	.waiting {
		color: orange;
	}
	.onscreen {
		color: green;
	}
	.digitsblock {
		display: inline-block;
		margin-left: 2em;
		border: solid 1px;
	}
	.digitsblock input {
		text-align: right;
	}
	#tools {
		border: dotted 1px gray;
		position: absolute;
		right: 0.5em;
		top: 0.5ex
	}
	</style>
</head>

<body>
	<script src='/scoreboard/static/jquery-3.1.0.js'></script>
	<script>
	var currentPoll = null;

	function setError(msg) {
		$("#message").html(msg);
	}
	function poll() {
		var poll_interval=0;
	
		currentPoll = $.ajax({
			url: "/scoreboard/poll",
			type: 'GET',
			dataType: 'json',
			success: function(data) {
				handleMessage(data);
				poll_interval=0;
			},
			error: function (xhr, status, error) {
				poll_interval=1000;
				setError("Poll error : " + status + "/" + error);
			},
			complete: function () {
				setTimeout(poll, poll_interval);
			},
		});
	}
	function handleMessage(data) {
		if (data == null) {
			console.warn("null");
			return;
		}
		if (data == "") {
			console.warn("empty");
			return;
		}
		console.log(data);
		for (k in data) {
			if (k == 'error') {
				setError(data[k])
			} else {
				$('#'+k)
					.val(data[k])
					.removeClass('waiting').addClass('onscreen');
			}
		}
		$('#message').html("<pre>message " + JSON.stringify(data) + "</pre>");
	}

	function addScoreButton(name, len) {
		var html = $('<div>')
			.addClass('digitsblock')
			.attr('id', name+'_block');
		html.append(
			$('<input>')
				.addClass('minus')
				.attr('type', 'button')
				.attr('id', name+'_minus')
				.attr('rel', name)
				.val('-1')
		);
		html.append(
			$('<input>')
				.addClass('digits')
				.attr('type', 'text')
				.attr('id', name)
				.attr('size', len)
				.val('-')
		);
		html.append(
			$('<input>')
				.addClass('plus')
				.attr('type', 'button')
				.attr('id', name+'_plus')
				.attr('rel', name)
				.val('+1')
		);

		$('#scores').append(html);
	}

	function addToolsButton(action) {
		$('#tools').append(
			$('<input>')
				.attr('type', 'button')
				.attr('id', action)
				.val(action)
				.addClass(action)
				.click(function(){
					$('.digits').addClass('waiting').removeClass('onscreen');
					$.ajax({
						url: '/scoreboard/' + action,
						type: 'GET',
						error: function(xhr, status, error) {
							setError("Can't " + action + " : " + status + "/" + error);
						}
					});
				})
		);
	}

	$( document ).ready(function() {
		// add scores button
		addScoreButton('FL', 1);
		addScoreButton('BL', 2);
		addScoreButton('FV', 1);
		addScoreButton('BV', 2);
		// handle +/-
		$('.plus').click(function() {
			var rel = $(this).attr('rel');
			var target = $('#'+rel)
			changeValue(rel, target, 1);
		});
		$('.minus').click(function() {
			var rel = $(this).attr('rel');
			var target = $('#'+rel)
			changeValue(rel, target, -1);
		});
		// and direct input
		$('.digits')
			.focus(function() {
				$(this).removeClass('waiting').removeClass('onscreen');
			})
			.change(function() {
				var target = $(this);
				var rel = target.attr('id')
				changeValue(rel, target);
			});

		addToolsButton('refresh');
		addToolsButton('test');
		addToolsButton('blank');
		// TODO : a button to reload page ?

		poll('/scoreboard/poll');
	});

	function changeValue(rel, target, delta) {
		var value = Number.parseInt(target.val());
		if (delta != null) {
			value += delta;
		}

		$.ajax({
			url: '/scoreboard/' + rel + '/' + value,
			type: 'GET',
			success: function(data) {
				handleMessage(data);
			},
			error: function(xhr, status, error) {
				setError("Can't set " + rel + " to " + value + " : " + status + "/" + error);
			}
		});
		target.addClass('waiting').removeClass('onscreen');
	}

	</script>
	<div id='message'></div>
	<div id='tools'></div>

	<h1>Let's go ...</h1>
	<div id='chrono' class="digitsblock">
		<input id="Minutes" class="digits" type="text" size="2" value="--">&nbsp;:&nbsp;
		<input id="Seconds" class="digits" type="text" size="2" value="--">
	</div>
	<div id='scores'></div>
</body>
</html>
